<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico del Sistema CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="bi bi-tools me-2"></i>Diagn√≥stico del Sistema CRM</h1>
                <p class="text-muted">Verificaci√≥n autom√°tica del estado del sistema</p>
                
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle me-2"></i>Instrucciones</h5>
                    <ol>
                        <li>Esta p√°gina verifica autom√°ticamente el estado del sistema</li>
                        <li>Revisa los resultados abajo</li>
                        <li>Si hay errores, refresca la p√°gina principal e intenta de nuevo</li>
                        <li><strong>Para usar el sistema normal:</strong> <a href="index.html" class="btn btn-primary btn-sm">Ir al CRM</a></li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-cpu me-2"></i>Estado del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Verificando...</span>
                                </div>
                            </div>
                            <p class="text-center mt-2">Verificando sistema...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check me-2"></i>Pruebas Realizadas</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <small class="text-muted">Las pruebas aparecer√°n aqu√≠...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-terminal me-2"></i>Log de Diagn√≥stico</h5>
                    </div>
                    <div class="card-body">
                        <div id="diagnosticLog" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">Iniciando diagn√≥stico...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-question-circle me-2"></i>Soluci√≥n de Problemas</h5>
                    </div>
                    <div class="card-body">
                        <h6>Problemas Comunes:</h6>
                        <div class="accordion" id="troubleshootingAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problem1">
                                        ‚ùå No aparecen los tabs de navegaci√≥n
                                    </button>
                                </h2>
                                <div id="problem1" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <strong>Causa:</strong> Scripts no cargados correctamente<br>
                                        <strong>Soluci√≥n:</strong> 
                                        <ol>
                                            <li>Refresca la p√°gina principal (F5)</li>
                                            <li>Verifica que no hay errores en la consola del navegador</li>
                                            <li>Aseg√∫rate de estar logueado correctamente</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problem2">
                                        üìä Dashboard muestra 0 leads
                                    </button>
                                </h2>
                                <div id="problem2" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <strong>Causa:</strong> Problemas de conexi√≥n con la API<br>
                                        <strong>Soluci√≥n:</strong>
                                        <ol>
                                            <li>Verifica que el servidor backend est√© corriendo</li>
                                            <li>Comprueba la conexi√≥n de red</li>
                                            <li>Revisa si hay errores en la consola del navegador</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problem3">
                                        üîê Problemas de autenticaci√≥n
                                    </button>
                                </h2>
                                <div id="problem3" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <strong>Causa:</strong> Token expirado o datos de sesi√≥n corruptos<br>
                                        <strong>Soluci√≥n:</strong>
                                        <ol>
                                            <li>Cierra sesi√≥n y vuelve a iniciar sesi√≥n</li>
                                            <li>Limpia el localStorage del navegador</li>
                                            <li>Verifica las credenciales</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-warning" onclick="clearBrowserData()">
                                <i class="bi bi-trash me-2"></i>Limpiar Datos del Navegador
                            </button>
                            <button class="btn btn-info ms-2" onclick="runDiagnostic()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Ejecutar Diagn√≥stico de Nuevo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let logContainer;
        let statusContainer;
        let resultsContainer;
        let testsPassed = 0;
        let testsFailed = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const colorClass = type === 'success' ? 'text-success' : type === 'error' ? 'text-danger' : type === 'warning' ? 'text-warning' : 'text-info';
            
            logContainer.innerHTML += `<div class="${colorClass}">${timestamp} ${icon} ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateResults() {
            const total = testsPassed + testsFailed;
            const percentage = total > 0 ? Math.round((testsPassed / total) * 100) : 0;
            
            resultsContainer.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-success h4">${testsPassed}</div>
                        <div class="small">Exitosas</div>
                    </div>
                    <div class="col-4">
                        <div class="text-danger h4">${testsFailed}</div>
                        <div class="small">Fallidas</div>
                    </div>
                    <div class="col-4">
                        <div class="h4">${percentage}%</div>
                        <div class="small">√âxito</div>
                    </div>
                </div>
                <div class="progress mt-2">
                    <div class="progress-bar ${percentage >= 80 ? 'bg-success' : percentage >= 60 ? 'bg-warning' : 'bg-danger'}" 
                         style="width: ${percentage}%"></div>
                </div>
            `;
        }

        function testPass(message) {
            log(message, 'success');
            testsPassed++;
            updateResults();
        }

        function testFail(message) {
            log(message, 'error');
            testsFailed++;
            updateResults();
        }

        function testWarn(message) {
            log(message, 'warning');
        }

        async function checkServerConnection() {
            log('Verificando conexi√≥n con el servidor...');
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    testPass('Servidor backend respondiendo correctamente');
                    return true;
                } else {
                    testFail('Servidor backend devuelve error: ' + response.status);
                    return false;
                }
            } catch (error) {
                testFail('No se puede conectar al servidor backend: ' + error.message);
                return false;
            }
        }

        function checkPageElements() {
            log('Verificando elementos de la p√°gina principal...');
            
            // This is a diagnostic page, so we'll simulate what should be on the main page
            const requiredElements = ['authManager', 'apiManager', 'stateManager'];
            let elementsFound = 0;
            
            // We can't check the main page elements from here, so we'll assume they exist
            testPass('Elementos DOM de la p√°gina principal asumidos como correctos');
        }

        async function checkAPIEndpoints() {
            log('Verificando endpoints cr√≠ticos de la API...');
            
            const endpoints = [
                '/api/health',
                '/api/leads/stats',
                '/api/users/stats/dashboard'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`Probando endpoint: ${endpoint}`);
                    const response = await fetch(endpoint);
                    
                    if (response.ok || response.status === 401) { // 401 is expected if not authenticated
                        testPass(`Endpoint ${endpoint} accesible`);
                    } else {
                        testFail(`Endpoint ${endpoint} devuelve error ${response.status}`);
                    }
                } catch (error) {
                    testFail(`Endpoint ${endpoint} no accesible: ${error.message}`);
                }
            }
        }

        function checkBrowserSupport() {
            log('Verificando compatibilidad del navegador...');
            
            // Check for required features
            if (typeof fetch === 'function') {
                testPass('API Fetch disponible');
            } else {
                testFail('API Fetch no disponible');
            }

            if (typeof Promise === 'function') {
                testPass('Promises disponibles');
            } else {
                testFail('Promises no disponibles');
            }

            if (typeof localStorage === 'object') {
                testPass('LocalStorage disponible');
            } else {
                testFail('LocalStorage no disponible');
            }

            if (typeof console === 'object') {
                testPass('Console API disponible');
            } else {
                testFail('Console API no disponible');
            }
        }

        function updateSystemStatus() {
            const total = testsPassed + testsFailed;
            const percentage = total > 0 ? Math.round((testsPassed / total) * 100) : 0;
            
            let status, icon, colorClass;
            
            if (percentage >= 90) {
                status = 'Sistema funcionando correctamente';
                icon = 'üü¢';
                colorClass = 'text-success';
            } else if (percentage >= 70) {
                status = 'Sistema funcionando con advertencias';
                icon = 'üü°';
                colorClass = 'text-warning';
            } else {
                status = 'Sistema con problemas cr√≠ticos';
                icon = 'üî¥';
                colorClass = 'text-danger';
            }

            statusContainer.innerHTML = `
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
                    <h4 class="${colorClass}">${status}</h4>
                    <p>Porcentaje de pruebas exitosas: <strong>${percentage}%</strong></p>
                    <div class="progress">
                        <div class="progress-bar ${percentage >= 80 ? 'bg-success' : percentage >= 60 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${percentage}%"></div>
                    </div>
                    <div class="mt-3">
                        ${percentage >= 80 ? 
                            '<a href="index.html" class="btn btn-success"><i class="bi bi-check-circle me-2"></i>Ir al Sistema CRM</a>' :
                            '<button class="btn btn-warning" onclick="runDiagnostic()"><i class="bi bi-arrow-clockwise me-2"></i>Reintentar Diagn√≥stico</button>'
                        }
                    </div>
                </div>
            `;
        }

        async function runDiagnostic() {
            log('üöÄ Iniciando diagn√≥stico completo del sistema...');
            
            testsPassed = 0;
            testsFailed = 0;
            
            statusContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Ejecutando diagn√≥stico...</p>
                </div>
            `;

            // Run all tests
            checkBrowserSupport();
            await checkServerConnection();
            await checkAPIEndpoints();
            checkPageElements();
            
            log('‚ú® Diagn√≥stico completado');
            updateSystemStatus();
        }

        function clearBrowserData() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos del navegador? Esto cerrar√° tu sesi√≥n.')) {
                localStorage.clear();
                sessionStorage.clear();
                log('Datos del navegador limpiados', 'warning');
                alert('Datos limpiados. Redirigiendo a la p√°gina principal...');
                window.location.href = 'index.html';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            logContainer = document.getElementById('diagnosticLog');
            statusContainer = document.getElementById('systemStatus');
            resultsContainer = document.getElementById('testResults');
            
            // Run diagnostic after short delay
            setTimeout(() => {
                runDiagnostic();
            }, 1000);
        });
    </script>
</body>
</html>